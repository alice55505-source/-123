import{r as u,j as _}from"./vendor--FBYh3JU.js";import{T as d,A as K}from"./index-B2XaBTTX.js";const re=({mediaList:h,settings:b,selectedOverlayId:Q,setSelectedOverlayId:X,appState:G,audio:L,onRenderingComplete:z,onProgress:q})=>{const H=u.useRef(null),[v,$]=u.useState(!1),[Y,V]=u.useState(0),x=u.useRef(0),j=u.useRef(0),F=u.useRef(0),A=u.useRef({}),D=u.useRef(!1),s=b.resolution.width,c=b.resolution.height;u.useEffect(()=>{(async()=>{for(const a of h){if(!A.current[a.id]){if(a.type==="video"){const e=document.createElement("video");e.src=a.previewUrl,e.muted=!0,e.load(),A.current[a.id]=e}else if(a.previewUrl){const e=new Image;e.src=a.previewUrl,await new Promise(f=>e.onload=f),A.current[a.id]=e}}for(const e of a.overlays)if(e.type==="image"&&e.sourceUrl&&!A.current[e.id]){const f=new Image;f.src=e.sourceUrl,await new Promise(k=>f.onload=k),A.current[e.id]=f}}O(x.current)})()},[h]);const O=u.useCallback(g=>{const a=H.current;if(!a)return;const e=a.getContext("2d");if(!e)return;const f=b.transitionDuration*1e3,k=h.reduce((r,n)=>r+(n.type==="video"?n.duration||5:b.photoDuration)*1e3,0),I=g%k;let C=0,S=0,P=0;for(let r=0;r<h.length;r++){const n=(h[r].type==="video"?h[r].duration||5:b.photoDuration)*1e3;if(I>=C&&I<C+n){S=r,P=C;break}C+=n}const i=h[S];if(!i)return;const o=(r,n=1,l=0,p=0,y=1)=>{if(e.save(),e.globalAlpha=n,r.file){e.fillStyle="#000",e.fillRect(0,0,s,c),e.translate(s/2,c/2),e.scale(y,y),e.translate(-s/2+l,-c/2+p);const t=A.current[r.id];if(t){const T=t instanceof HTMLVideoElement?t.videoWidth:t.width,R=t instanceof HTMLVideoElement?t.videoHeight:t.height;if(T>0&&R>0){const E=Math.max(s/T,c/R),w=T*E,m=R*E;e.drawImage(t,(s-w)/2,(c-m)/2,w,m)}}}else{if(e.translate(s/2,c/2),e.scale(y,y),e.translate(-s/2+l,-c/2+p),r.gradientColors){const t=e.createLinearGradient(0,0,s,c);t.addColorStop(0,r.gradientColors.start),t.addColorStop(1,r.gradientColors.end),e.fillStyle=t}else e.fillStyle="#1e293b";e.fillRect(0,0,s,c)}r.overlays.forEach(t=>{e.save();let T=1;(v||D.current)&&t.type==="sticker"&&(T=1+Math.sin(g/200)*.1);const R=t.width*t.scale,E=t.height*t.scale;if(e.translate(t.x+R/2,t.y+E/2),e.rotate(t.rotation),e.scale(T,T),e.translate(-R/2,-E/2),t.type==="image"){const w=A.current[t.id];if(w){const m=t.crop||{t:0,b:0,l:0,r:0};e.drawImage(w,w.width*m.l,w.height*m.t,w.width*(1-m.l-m.r),w.height*(1-m.t-m.b),0,0,R,E)}}else if(t.type==="text"){e.font=`bold ${t.fontSize}px ${t.fontFamily}`;const m=e.measureText(t.text||"").width,J=t.fontSize||60,U=t.backgroundPadding||0;t.backgroundColor&&(e.fillStyle=t.backgroundColor,e.globalAlpha=(t.backgroundOpacity||.7)*n,e.beginPath(),e.roundRect(-U,-U,m+U*2,J+U*2,t.backgroundRadius||10),e.fill()),e.globalAlpha=n,e.textBaseline="top",t.strokeColor&&(t.strokeWidth||0)>0&&(e.strokeStyle=t.strokeColor,e.lineWidth=(t.strokeWidth||0)*2,e.lineJoin="round",e.strokeText(t.text||"",0,0)),e.fillStyle=t.color||"#fff",e.fillText(t.text||"",0,0)}else t.type==="sticker"&&(e.font=`${E}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(t.emoji||"",R/2,E/2));e.restore()}),e.restore()};e.fillStyle="#000",e.fillRect(0,0,s,c);const N=(i.type==="video"?i.duration||5:b.photoDuration)*1e3,M=I-P;if(M>N-f&&S<h.length-1){const r=h[S+1],n=(M-(N-f))/f,l=[d.FADE,d.SLIDE_UP,d.SLIDE_DOWN,d.SLIDE_LEFT,d.SLIDE_RIGHT,d.ZOOM_IN];switch(i.transition===d.RANDOM?l[S%l.length]:i.transition){case d.SLIDE_LEFT:o(i,1,-s*n),o(r,1,s*(1-n));break;case d.SLIDE_RIGHT:o(i,1,s*n),o(r,1,-s*(1-n));break;case d.SLIDE_UP:o(i,1,0,-c*n),o(r,1,0,c*(1-n));break;case d.SLIDE_DOWN:o(i,1,0,c*n),o(r,1,0,-c*(1-n));break;case d.ZOOM_IN:o(i,1-n,0,0,1+n*.5),o(r,n,0,0,.5+n*.5);break;case d.FADE:default:o(i,1-n),o(r,n);break}}else o(i,1)},[h,b,v]);u.useEffect(()=>{G===K.RENDERING&&!D.current&&Z()},[G]);const Z=async()=>{const g=H.current;if(!g)return;D.current=!0,$(!1),x.current=0,V(0);const a=g.captureStream(30),e=new(window.AudioContext||window.webkitAudioContext),f=e.createMediaStreamDestination(),k=h.reduce((r,n)=>r+(n.type==="video"?n.duration||5:b.photoDuration)*1e3,0),I=k/1e3,C=await Promise.all(L.map(async r=>{try{const l=await(await fetch(r.url)).arrayBuffer();return await e.decodeAudioData(l)}catch{return null}}));let S=0;const P=2,i=2;C.forEach(r=>{if(!r)return;const n=e.createBufferSource(),l=e.createGain();n.buffer=r,n.connect(l),l.connect(f);const p=S;let y=r.duration;p+y>I&&(y=Math.max(0,I-p));const t=p+y;if(y<=0)return;l.gain.setValueAtTime(0,p),l.gain.linearRampToValueAtTime(1,Math.min(p+i,t));const T=Math.max(p,t-i);l.gain.setValueAtTime(1,T),l.gain.linearRampToValueAtTime(0,t),n.start(p),n.stop(t),S=t+P}),L.length>0&&f.stream.getAudioTracks().forEach(r=>a.addTrack(r));const o=new MediaRecorder(a,{mimeType:"video/webm;codecs=vp9"}),N=[];o.ondataavailable=r=>N.push(r.data),o.onstop=()=>{const r=new Blob(N,{type:"video/webm"});z(URL.createObjectURL(r)),D.current=!1,e.close()},o.start();let M=performance.now();const B=r=>{if(!D.current)return;const n=r-M;if(M=r,x.current+=n,x.current>=k){o.stop();return}V(x.current),q&&q(Math.floor(x.current/k*100)),O(x.current),requestAnimationFrame(B)};M=performance.now(),requestAnimationFrame(B)},W=u.useCallback(g=>{if(!v||D.current)return;F.current||(F.current=g-x.current);const a=g-F.current;x.current=a,V(a),O(a),j.current=requestAnimationFrame(W)},[v,O]);return u.useEffect(()=>(v?(F.current=0,j.current=requestAnimationFrame(W)):cancelAnimationFrame(j.current),()=>cancelAnimationFrame(j.current)),[v,W]),_.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center relative bg-black group/preview overflow-hidden",children:[_.jsx("canvas",{ref:H,width:s,height:c,className:"max-w-full max-h-full object-contain shadow-2xl"}),!D.current&&_.jsx("div",{className:"absolute bottom-8 flex gap-6 opacity-0 group-hover/preview:opacity-100 transition-all",children:_.jsx("button",{onClick:()=>$(!v),className:"w-16 h-16 bg-indigo-600/90 backdrop-blur-xl rounded-full flex items-center justify-center text-white border border-white/20 shadow-2xl hover:scale-110 active:scale-90 transition-all",children:_.jsx("span",{className:"text-2xl",children:v?"⏸":"▶️"})})})]})};export{re as default};
