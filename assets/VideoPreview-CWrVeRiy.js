import{r as d,j as O}from"./vendor--FBYh3JU.js";import{T as f,A as K}from"./index-DNZexY8j.js";const re=({mediaList:p,settings:b,selectedOverlayId:Q,setSelectedOverlayId:X,appState:G,audio:L,onRenderingComplete:z,onProgress:q})=>{const H=d.useRef(null),[v,$]=d.useState(!1),[Y,V]=d.useState(0),x=d.useRef(0),_=d.useRef(0),j=d.useRef(0),A=d.useRef({}),D=d.useRef(!1),s=b.resolution.width,c=b.resolution.height;d.useEffect(()=>{(async()=>{for(const o of p){if(!A.current[o.id]){if(o.type==="video"){const e=document.createElement("video");e.crossOrigin="anonymous",e.src=o.previewUrl,e.muted=!0,e.load(),A.current[o.id]=e}else if(o.previewUrl){const e=new Image;e.crossOrigin="anonymous",e.src=o.previewUrl,await new Promise(u=>e.onload=u),A.current[o.id]=e}}for(const e of o.overlays)if(e.type==="image"&&e.sourceUrl&&!A.current[e.id]){const u=new Image;u.crossOrigin="anonymous",u.src=e.sourceUrl,await new Promise(k=>u.onload=k),A.current[e.id]=u}}F(x.current)})()},[p]);const F=d.useCallback(g=>{const o=H.current;if(!o)return;const e=o.getContext("2d");if(!e)return;const u=b.transitionDuration*1e3,k=p.reduce((r,n)=>r+(n.type==="video"?n.duration||5:b.photoDuration)*1e3,0),I=g%k;let C=0,S=0,U=0;for(let r=0;r<p.length;r++){const n=(p[r].type==="video"?p[r].duration||5:b.photoDuration)*1e3;if(I>=C&&I<C+n){S=r,U=C;break}C+=n}const i=p[S];if(!i)return;const a=(r,n=1,l=0,h=0,y=1)=>{if(e.save(),e.globalAlpha=n,r.file||r.previewUrl){e.fillStyle="#000",e.fillRect(0,0,s,c),e.translate(s/2,c/2),e.scale(y,y),e.translate(-s/2+l,-c/2+h);const t=A.current[r.id];if(t){const T=t instanceof HTMLVideoElement?t.videoWidth:t.width,R=t instanceof HTMLVideoElement?t.videoHeight:t.height;if(T>0&&R>0){const E=Math.max(s/T,c/R),w=T*E,m=R*E;e.drawImage(t,(s-w)/2,(c-m)/2,w,m)}}}else{if(e.translate(s/2,c/2),e.scale(y,y),e.translate(-s/2+l,-c/2+h),r.gradientColors){const t=e.createLinearGradient(0,0,s,c);t.addColorStop(0,r.gradientColors.start),t.addColorStop(1,r.gradientColors.end),e.fillStyle=t}else e.fillStyle="#1e293b";e.fillRect(0,0,s,c)}r.overlays.forEach(t=>{e.save();let T=1;(v||D.current)&&t.type==="sticker"&&(T=1+Math.sin(g/200)*.1);const R=t.width*t.scale,E=t.height*t.scale;if(e.translate(t.x+R/2,t.y+E/2),e.rotate(t.rotation),e.scale(T,T),e.translate(-R/2,-E/2),t.type==="image"){const w=A.current[t.id];if(w){const m=t.crop||{t:0,b:0,l:0,r:0};e.drawImage(w,w.width*m.l,w.height*m.t,w.width*(1-m.l-m.r),w.height*(1-m.t-m.b),0,0,R,E)}}else if(t.type==="text"){e.font=`bold ${t.fontSize}px ${t.fontFamily}`;const m=e.measureText(t.text||"").width,J=t.fontSize||60,P=t.backgroundPadding||0;t.backgroundColor&&(e.fillStyle=t.backgroundColor,e.globalAlpha=(t.backgroundOpacity||.7)*n,e.beginPath(),e.roundRect(-P,-P,m+P*2,J+P*2,t.backgroundRadius||10),e.fill()),e.globalAlpha=n,e.textBaseline="top",t.strokeColor&&(t.strokeWidth||0)>0&&(e.strokeStyle=t.strokeColor,e.lineWidth=(t.strokeWidth||0)*2,e.lineJoin="round",e.strokeText(t.text||"",0,0)),e.fillStyle=t.color||"#fff",e.fillText(t.text||"",0,0)}else t.type==="sticker"&&(e.font=`${E}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(t.emoji||"",R/2,E/2));e.restore()}),e.restore()};e.fillStyle="#000",e.fillRect(0,0,s,c);const N=(i.type==="video"?i.duration||5:b.photoDuration)*1e3,M=I-U;if(M>N-u&&S<p.length-1){const r=p[S+1],n=(M-(N-u))/u,l=[f.FADE,f.SLIDE_UP,f.SLIDE_DOWN,f.SLIDE_LEFT,f.SLIDE_RIGHT,f.ZOOM_IN];switch(i.transition===f.RANDOM?l[S%l.length]:i.transition){case f.SLIDE_LEFT:a(i,1,-s*n),a(r,1,s*(1-n));break;case f.SLIDE_RIGHT:a(i,1,s*n),a(r,1,-s*(1-n));break;case f.SLIDE_UP:a(i,1,0,-c*n),a(r,1,0,c*(1-n));break;case f.SLIDE_DOWN:a(i,1,0,c*n),a(r,1,0,-c*(1-n));break;case f.ZOOM_IN:a(i,1-n,0,0,1+n*.5),a(r,n,0,0,.5+n*.5);break;case f.FADE:default:a(i,1-n),a(r,n);break}}else a(i,1)},[p,b,v]);d.useEffect(()=>{G===K.RENDERING&&!D.current&&Z()},[G]);const Z=async()=>{const g=H.current;if(!g)return;D.current=!0,$(!1),x.current=0,V(0);const o=g.captureStream(30),e=new(window.AudioContext||window.webkitAudioContext),u=e.createMediaStreamDestination(),k=p.reduce((r,n)=>r+(n.type==="video"?n.duration||5:b.photoDuration)*1e3,0),I=k/1e3,C=await Promise.all(L.map(async r=>{try{const l=await(await fetch(r.url)).arrayBuffer();return await e.decodeAudioData(l)}catch{return null}}));let S=0;const U=2,i=2;C.forEach(r=>{if(!r)return;const n=e.createBufferSource(),l=e.createGain();n.buffer=r,n.connect(l),l.connect(u);const h=S;let y=r.duration;h+y>I&&(y=Math.max(0,I-h));const t=h+y;if(y<=0)return;l.gain.setValueAtTime(0,h),l.gain.linearRampToValueAtTime(1,Math.min(h+i,t));const T=Math.max(h,t-i);l.gain.setValueAtTime(1,T),l.gain.linearRampToValueAtTime(0,t),n.start(h),n.stop(t),S=t+U}),L.length>0&&u.stream.getAudioTracks().forEach(r=>o.addTrack(r));const a=new MediaRecorder(o,{mimeType:"video/webm;codecs=vp9"}),N=[];a.ondataavailable=r=>N.push(r.data),a.onstop=()=>{const r=new Blob(N,{type:"video/webm"});z(URL.createObjectURL(r)),D.current=!1,e.close()},a.start();let M=performance.now();const B=r=>{if(!D.current)return;const n=r-M;if(M=r,x.current+=n,x.current>=k){a.stop();return}V(x.current),q&&q(Math.floor(x.current/k*100)),F(x.current),requestAnimationFrame(B)};M=performance.now(),requestAnimationFrame(B)},W=d.useCallback(g=>{if(!v||D.current)return;j.current||(j.current=g-x.current);const o=g-j.current;x.current=o,V(o),F(o),_.current=requestAnimationFrame(W)},[v,F]);return d.useEffect(()=>(v?(j.current=0,_.current=requestAnimationFrame(W)):cancelAnimationFrame(_.current),()=>cancelAnimationFrame(_.current)),[v,W]),O.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center relative bg-black group/preview overflow-hidden",children:[O.jsx("canvas",{ref:H,width:s,height:c,className:"max-w-full max-h-full object-contain shadow-2xl"}),!D.current&&O.jsx("div",{className:"absolute bottom-8 flex gap-6 opacity-0 group-hover/preview:opacity-100 transition-all",children:O.jsx("button",{onClick:()=>$(!v),className:"w-16 h-16 bg-indigo-600/90 backdrop-blur-xl rounded-full flex items-center justify-center text-white border border-white/20 shadow-2xl hover:scale-110 active:scale-90 transition-all",children:O.jsx("span",{className:"text-2xl",children:v?"⏸":"▶️"})})})]})};export{re as default};
